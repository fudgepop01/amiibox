import*as tslib_1 from"../polyfills/tslib.js";import{h}from"../fudgeapps.core.js";function isInprogress(e){return!(!e||!e.content)}var EditController=function(){function e(e){this.parent=e,this.added=new Uint8Array,this.pieces=[],this.chunk="",this.original=e.file,this.pieces=[{offset:0,length:this.original.length,source:"origin"}]}return e.prototype.initEdit=function(e,t){var i,n;if(this.inProgress={offset:e,type:t,content:[],index:-1,get length(){return this.content.length}},"insert"===t){for(var r=0,s=void 0,o=void 0,h=void 0,l=0,a=this.pieces.entries();l<a.length;l++){var c=a[l],d=c[0];if((r+=(p=c[1]).length)>=e){s=p.length-r+e,o=d,h=p;break}}this.inProgress.index=o+1,(i=this.pieces).splice.apply(i,[o,1].concat([{offset:h.offset,length:s,source:h.source},this.inProgress,{offset:h.offset+s,length:h.length-s,source:h.source}]))}else{r=0,s=void 0,o=void 0,h=void 0;for(var u=0,g=this.pieces.entries();u<g.length;u++){var p,f=g[u];if(d=f[0],(r+=(p=f[1]).length)>=e){s=p.length-r+e,o=d,h=p;break}}this.inProgress.index=o+1,(n=this.pieces).splice.apply(n,[o,1].concat([{offset:h.offset,length:s,source:h.source},this.inProgress,{offset:h.offset+s,length:h.length-s,source:h.source}]))}},e.prototype.buildEdit=function(e){if(/^[a-fA-F0-9]$/.test(e.key)&&(this.chunk+=e.key,2===this.chunk.length)){this.inProgress.content.push(parseInt(this.chunk,16)),this.chunk="",this.parent.setCursorPosition(this.parent.cursor+1);var t=this.pieces.indexOf(this.inProgress);if("overwrite"===this.inProgress.type&&t!==this.pieces.length-1){var i=this.pieces[t+1];i.offset+=1,i.length-=1,0===i.length&&this.pieces.splice(t+1,1)}}},e.prototype.commit=function(){var e=new Uint8Array(this.added.length+this.inProgress.content.length);e.set(this.added,0),e.set(this.inProgress.content,this.added.length),this.pieces[this.inProgress.index]={offset:this.added.length,length:this.inProgress.length,source:"added"},this.added=e,this.inProgress=null,this.chunk=""},e.prototype.render=function(e,t){for(var i,n=new Uint8Array(t),r={added:[]},s=0,o=0,h=0,l=this.pieces.entries();h<l.length;h++){var a=l[h],c=a[0];if((s+=(u=a[1]).length)>=e){i=u.length-s+e,o=c;break}}(isInprogress(this.pieces[o])||"added"===this.pieces[o].source)&&r.added.push([e-i,e-i+this.pieces[o].length]);var d=this.getPieceBuffer(this.pieces[o]).subarray(i,i+t);for(s=d.length,n.set(d,0),c=o+1;c<this.pieces.length;c++){var u;if(s+=(u=this.pieces[c]).length,(isInprogress(u)||"added"===u.source)&&r.added.push([e+s-u.length,e+s]),s>=t){n.set(this.getPieceBuffer(u).subarray(0,u.length-s+t),s-u.length);break}n.set(this.getPieceBuffer(u),s-u.length)}return s!==t?{out:n.subarray(0,s),meta:r}:{out:n,meta:r}},Object.defineProperty(e.prototype,"length",{get:function(){for(var e=0,t=0,i=this.pieces;t<i.length;t++)e+=i[t].length;return e},enumerable:!0,configurable:!0}),e.prototype.rollback=function(){},e.prototype.save=function(){return this.render(0,this.length).out},e.prototype.getPieceBuffer=function(e){return isInprogress(e)?new Uint8Array(e.content):"origin"===e.source?this.original.subarray(e.offset,e.offset+e.length):this.added.subarray(e.offset,e.offset+e.length)},e}(),HexEditor=function(){function e(){var e=this;this.lineNumber=0,this.displayAscii=!0,this.maxLines=30,this.bytesPerLine=16,this.bytesUntilForcedLine=0,this.asciiInline=!1,this.bytesPerGroup=4,this.mode="edit",this.editType="overwrite",this.regionDepth=2,this.regions=[],this.scroll=function(t){t.preventDefault();var i=Number.isInteger(t.deltaY)?Math.ceil(t.deltaY/2):Math.ceil(t.deltaY/100);-0===i&&(i-=1),e.lineNumber+i<0?e.lineNumber=0:e.lineNumber+i>Math.floor(e.editController.length/e.bytesPerLine)-1?e.lineNumber=Math.floor(e.editController.length/e.bytesPerLine)-1:e.lineNumber+=i}}return e.prototype.componentWillLoad=function(){this.file=new Uint8Array(32),this.editController=new EditController(this),this.regionScaleWidth=28,this.regionScaleHeight=17},e.prototype.componentDidLoad=function(){this.hexLoaded.emit(this.editController)},e.prototype.acceptFile=function(e){return tslib_1.__awaiter(this,void 0,void 0,function(){var t,i=this;return tslib_1.__generator(this,function(n){return console.log(e),this.fileMetadata=e,(t=new FileReader).readAsArrayBuffer(e),t.onload=function(e){i.file=new Uint8Array(e.target.result),i.editController=new EditController(i)},[2]})})},e.prototype.saveFile=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(e){return null==this.file?[2]:[2,this.editController.save()]})})},e.prototype.setLineNumber=function(e){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(t){return this.lineNumber=e,this.hexLineChanged.emit(e),[2]})})},e.prototype.setCursorPosition=function(e){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(t){return this.cursor=e,[2]})})},e.prototype.setSelection=function(e){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(t){return this.selection=Object.assign({},this.selection,e),[2]})})},e.prototype.getChunk=function(e,t){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(i){return[2,this.editController.render(e,t)]})})},e.prototype.getFileMetadata=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(e){return[2,this.fileMetadata]})})},e.prototype.buildHexView=function(){for(var e=this,t=this,i=t.lineNumber,n=t.maxLines,r=t.bytesPerLine,s=t.bytesPerGroup,o=t.asciiInline,l=i*r,a=this.editController.render(l,n*r),c=a.out,d=a.meta.added,u=[],g=0;g<n;g++)u.push(c.subarray(g*r,(g+1)*r));for(var p=[],f=[],b=0,m=u.entries();b<m.length;b++){var y=m[b],v=y[0],P=y[1];if(0===P.length)break;for(var L=l+v*r,x=[],S=[],_="•",w=!1,C=0,E=P.values().slice().entries();C<E.length;C++){var M,k=E[C],A=k[0],B=k[1];_=/\w|[!@#$%^&*()_+=\]\\:;"'>.<,\/?]/.test(String.fromCharCode(B))?String.fromCharCode(B):"•",M=o&&/\w/.test(_)?"."+_:B.toString(16).toUpperCase().padStart(2,"0");var H=[];A%s==s-1&&H.push("padByte"),this.cursor===L+A&&(H.push("cursor"),w=!0),this.selection&&this.selection.start<=L+A&&L+A<=this.selection.end&&H.push("selected");for(var N=0,U=d;N<U.length;N++){var F=U[N];if(F[0]<=L+A&&L+A<F[1]){H.push("added");break}}x.push(h("span",{class:H.join(" ")},_)),S.push(h("span",{class:H.join(" ")},M))}p.push(h("div",{class:"hexLine"+(w?" selected":"")},S)),f.push(h("div",{class:"charLine"+(w?" selected":"")},x))}for(;p.length<n;)p.push(h("div",{class:"hexLine",style:{pointerEvents:"none"}},h("span",null,"-"))),f.push(h("div",{class:"charLine",style:{pointerEvents:"none"}},h("span",null,"-")));var O=[];for(g=0;g<n;g++)O.push(h("div",{class:"lineLabel",style:{pointerEvents:"none"}},"0x"+(l+g*r).toString(16).padStart(8," ")));for(var D=[],I=function(t,n,r){if(void 0===n&&(n=0),t.end<l||t.start>l+e.maxLines*e.bytesPerLine){if(t.subRegions&&n+1!==e.regionDepth)for(var s=0,o=t.subRegions.entries();s<o.length;s++){var a=o[s];I(a[1],n+1,a[0])}}else if(n!==e.regionDepth){var c=t.start%e.bytesPerLine,d=t.end%e.bytesPerLine,u=Math.floor((t.end-t.start+c)/e.bytesPerLine),g=Math.floor(t.start/e.bytesPerLine)-i;if(D.push(h("polygon",{onmousemove:"\n            if (window.canUpdateMousemove === undefined) {\n              window.canUpdateMousemove = true;\n            }\n            if (window.canUpdateMousemove) {\n              window.canUpdateMousemove = false;\n              document.documentElement.style.setProperty('--mouse-x', event.clientX);\n              document.documentElement.style.setProperty('--mouse-y', event.clientY);\n              document.getElementById('tooltip').setAttribute('active', true)\n              document.getElementById('tooltip').setAttribute('complex', '"+JSON.stringify(Object.assign({},t,{subRegions:t.subRegions?t.subRegions.map(function(e){return e.name}):null}))+"');\n\n              setTimeout(() => {window.canUpdateMousemove = true}, 50);\n            }\n          ",onmouseleave:"document.getElementById('tooltip').setAttribute('active', false)",class:"region",points:"\n            0,"+(1+g)*e.regionScaleHeight+"\n            "+c*e.regionScaleWidth+","+(1+g)*e.regionScaleHeight+"\n            "+c*e.regionScaleWidth+","+g*e.regionScaleHeight+"\n            "+e.bytesPerLine*e.regionScaleWidth+","+g*e.regionScaleHeight+"\n            "+e.bytesPerLine*e.regionScaleWidth+","+(u+g)*e.regionScaleHeight+"\n            "+d*e.regionScaleWidth+","+(u+g)*e.regionScaleHeight+"\n            "+d*e.regionScaleWidth+","+(u+g+1)*e.regionScaleHeight+"\n            0,"+(u+1+g)*e.regionScaleHeight+"\n            ",fill:t.color||{0:["#88F","#BBF"],1:["#F88","#FBB"],2:["#8D8","#BDB"]}[n%3][r%2],stroke:"none"})),t.subRegions&&n+1!==e.regionDepth)for(var p=0,f=t.subRegions.entries();p<f.length;p++){var b=f[p];I(b[1],n+1,b[0])}}},R=0,j=this.regions.entries();R<j.length;R++){var W=j[R];I(W[1],0,g=W[0])}return{lineViews:p,charViews:f,lineLabels:O,regionMarkers:h("svg",{viewbox:"0 0 "+this.bytesPerLine*this.regionScaleWidth+" "+this.maxLines*this.regionScaleHeight,width:""+this.bytesPerLine*this.regionScaleWidth,height:""+this.maxLines*this.regionScaleHeight},D)}},e.prototype.edit=function(e){if("readonly"!==this.editType){var t=this.editController;t.inProgress||t.initEdit(this.cursor,this.editType),t.buildEdit(e)}},e.prototype.showHex=function(){var e=this,t=this.buildHexView(),i=t.lineViews,n=t.charViews,r=t.lineLabels,s=t.regionMarkers;return h("div",{class:"hex",onMouseEnter:function(t){return e._toggleScrollListener(t)},onMouseLeave:function(t){return e._toggleScrollListener(t)},onMouseDown:function(t){return e.beginSelection(t)},onMouseUp:function(t){return e.endSelection(t)},tabindex:"0",onKeyDown:function(t){return e.edit(t)}},h("div",{id:"MEASURE",class:"hex",style:{position:"absolute",visibility:"hidden",padding:"0 5px"}},"AB"),h("div",{class:"lineLabels"},r),h("div",{class:"hexView"},h("div",{class:"highlight",style:{position:"absolute",top:"0",display:"noregion"===this.mode?"none":"block",zIndex:"region"===this.mode?"3":"0"}},s),h("div",{class:"main"},i)),this.displayAscii?h("div",{class:"asciiView"},n):null)},e.prototype.beginSelection=function(e){"HEX-SCROLLBAR"!==e.target.id&&(this.tempSelection=this.lineNumber*this.bytesPerLine+e.composedPath()[2].children.slice().indexOf(e.composedPath()[1])*this.bytesPerLine+e.composedPath()[1].children.slice().indexOf(e.composedPath()[0]))},e.prototype.endSelection=function(e){if("HEX-SCROLLBAR"!==e.target.id){var t=this.lineNumber*this.bytesPerLine+e.composedPath()[2].children.slice().indexOf(e.composedPath()[1])*this.bytesPerLine+e.composedPath()[1].children.slice().indexOf(e.composedPath()[0]);this.selection=this.tempSelection>t?{start:t,end:this.tempSelection}:{start:this.tempSelection,end:t},this.tempSelection=null,this.cursor=t,this.hexCursorChanged.emit(this.cursor),this.hexSelectionChanged.emit(this.selection),this.editController.inProgress&&(this.editController.commit(),this.hexDataChanged.emit())}},e.prototype.render=function(){return h("div",{class:"fudgedit-container"},this.showHex())},e.prototype._toggleScrollListener=function(e){"mouseenter"===e.type?e.target.addEventListener("wheel",this.scroll,{passive:!1}):e.target.removeEventListener("wheel",this.scroll,!1)},Object.defineProperty(e,"is",{get:function(){return"fudge-hex-editor"},enumerable:!0,configurable:!0}),Object.defineProperty(e,"properties",{get:function(){return{acceptFile:{method:!0},asciiInline:{type:Boolean,attr:"ascii-inline"},bytesPerGroup:{type:Number,attr:"bytes-per-group"},bytesPerLine:{type:Number,attr:"bytes-per-line"},bytesUntilForcedLine:{type:Number,attr:"bytes-until-forced-line"},cursor:{state:!0},displayAscii:{type:Boolean,attr:"display-ascii"},editType:{type:String,attr:"edit-type"},file:{state:!0},fileMetadata:{state:!0},getChunk:{method:!0},getFileMetadata:{method:!0},lineNumber:{state:!0},maxLines:{type:Number,attr:"max-lines"},mode:{type:String,attr:"mode"},regionDepth:{type:Number,attr:"region-depth"},regions:{type:"Any",attr:"regions"},saveFile:{method:!0},selection:{state:!0},setCursorPosition:{method:!0},setLineNumber:{method:!0},setSelection:{method:!0}}},enumerable:!0,configurable:!0}),Object.defineProperty(e,"events",{get:function(){return[{name:"hexLineChanged",method:"hexLineChanged",bubbles:!0,cancelable:!0,composed:!0},{name:"hexCursorChanged",method:"hexCursorChanged",bubbles:!0,cancelable:!0,composed:!0},{name:"hexSelectionChanged",method:"hexSelectionChanged",bubbles:!0,cancelable:!0,composed:!0},{name:"hexDataChanged",method:"hexDataChanged",bubbles:!0,cancelable:!0,composed:!0},{name:"hexLoaded",method:"hexLoaded",bubbles:!0,cancelable:!0,composed:!0}]},enumerable:!0,configurable:!0}),Object.defineProperty(e,"style",{get:function(){return".fudgedit-container{overflow:hidden;position:relative;min-height:100%;color:#000}.hex{font-family:Sourcecode Pro,Courier,monospace;font-size:15px;height:100%;outline:none}.asciiView,.hexView,.lineLabels{display:inline-block;padding:0 10px;white-space:pre;position:relative}.charLine span,.hexLine span{position:relative;height:17px;display:inline-block}.lineLabel{height:17px}.hexLine span{position:relative;padding:0 5px;width:28px;-webkit-box-sizing:border-box;box-sizing:border-box}.hexLine span:not(:last-child).padByte:after{background-color:rgba(0,0,0,.4);position:absolute;width:2px;height:100%;left:calc(100% - 1px);content:\"\"}.hexLine span{cursor:default;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.charLine span.selected,.hexLine span.selected{background-color:rgba(136,136,255,.5)}.charLine span.cursor,.hexLine span.cursor{background-color:#008;color:#fff}.charLine span.added,.hexLine span.added{color:red}.hexLine span:hover{background-color:#000;color:#fff}.charLine:nth-child(2n-1),.hexLine:nth-child(2n-1),.lineLabel:nth-child(2n-1){background-color:#eff}.charLine.selected,.hexLine.selected{background-color:#ffa}.region{opacity:1}.highlight{mix-blend-mode:multiply}.region{position:relative}.highlight:hover .region:not(:hover){fill:rgba(0,0,0,.2)}"},enumerable:!0,configurable:!0}),e}();export{HexEditor as FudgeHexEditor};